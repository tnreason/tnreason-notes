\section{Graph Manipulation}

The graph $\graph$ can result from manipulations: e.g. Bethe-Clustering ("deltafication").


We have two manipulation strategies, which we show to preserve contractions:
\begin{itemize}
    \item Bethe construction of factor graphs
    \item Coarse graining
\end{itemize}

\subsection{Factor graphs}

%\begin{definition}
%    The factor graph to a hypergraph $\graph=(\nodes,\edges)$ is $G^{factor}=()$
%\end{definition}

\begin{definition}
    Given a tensor network $\tnetof{\graph}$ on a decorated hypergraph $\graph$, we define the bethe hypergraph $\secgraph$ as
    $(\secnodes, \secedges \cup \Delta^{\graph})$ where we have
    \begin{itemize}
        \item Recolored Edges $\secedges = \{\tilde{\edge} \wcols \edge\in \edges\}$ where $\tilde{\edge} = \{\node^{\edge} \wcols \node\in\edge\}$, which decoration tensor has same coordinates as $\hypercoreof{\edge}$
        \item Nodes $\secnodes = \nodes \cup (\bigcup_{\edge\in\edges}\tilde{\edge})$ %$\secnodes = \bigcup_{\edge\in\edges}\{\node^{\edge} \wcols \node\in\edge \}$
        \item Delta Edges $\Delta^{\graph} =  \big\{ \{\node\} \cup \{\node^{\edge} \wcols \edge\ni\node \}\wcols \node\in\nodes \big\} $, each of which decorated by a delta tensor $\delta^{\{\node^{\edge} \wcols \edge\ni\node \}}$
    \end{itemize}
\end{definition}

% Bipartite
The resulting overlap graph is bipartite, since any variable appears exactly in one cluster in $\secedges$ and in one cluster of $\Delta^{\graph}$.
This further makes the dual of the Bethe Cluster Hypergraph a proper graph (i.e. edges consistent of node pairs).

We effectively copy each node $\node$ by $\node^{\edge}$.
Let us now show, that when assigning dirac delta tensors the contraction reproduces the original contraction.

By adding delta tensors to each node $\node\in\nodes$ and defining its leg variables by $\node^{\edge}$ for $\edge\in\edges$.
We mark each such delta tensor by a cluster in $\Delta^{\graph}$, as defined in the following (see also \figref{fig:betheDataExample}).

By \lemref{lem:deltification} this construction does not change contractions.

\begin{lemma}[Bethe Invariance]
    Given a tensor network $\extnetwith$ on a hypergraph $\graph$.
    We define a tensor network on its bethe hypergraph $\secgraph$ by the tensors for $\edge\in\edges$
    \begin{align*}
        \sechypercoreofat{\tilde{\edge}}{\catvariableof{\tilde{\edge}}}
        = \contractionof{\hypercoreofat{\edge}{\catvariableof{\edge}},\identityat{\catvariableof{\edge},\catvariableof{\tilde{\edge}}}}{\catvariableof{\tilde{\edge}}}
    \end{align*}
    and the tensors for $\tilde{\edge}\in\Delta^{\graph}$
    \begin{align*}
        \sechypercoreofat{\tilde{\edge}}{\catvariableof{\tilde{\edge}},\catvariableof{\node}}
        = \identityat{\catvariableof{\tilde{\edge}},\catvariableof{\node}} \, .
    \end{align*}
    Then we have
    \begin{align*}
        \extnetwith =
        \contractionof{\{\sechypercoreofat{\tilde{\edge}}{\catvariableof{\tilde{\edge}}} \wcols \tilde{\edge}\in\secedges \cup \Delta^{\graph}\}}{\nodevariables}
    \end{align*}
\end{lemma}
\begin{proof}
    By invariance of adding dirac deltas.
\end{proof}

Equal constructions:
\begin{itemize}
    \item BP on factor graphs in \cite{mezard_information_2009}
    \item Bethe Cluster graphs in \cite{koller_probabilistic_2009}
\end{itemize}

\begin{figure}[t]
    \begin{center}
        \input{tikz_pics/bethe_hypergraph_example}
    \end{center}
    \caption{Example of a Bethe Cluster Graph.
    a) Example of a Tensor Network $\tnetof{\graph}$, which represents the by $\lambda$ averaged evaluation of the formula $(a\land b)\lor c$ on data $\datamap$.
    b) Corresponding Bethe Cluster Hypergraph, which dual is bipartite by the sets $\Delta$ and $\tilde{\edges}$.
    }
    \label{fig:betheDataExample}
\end{figure}

\subsection{Coarse graining}

\begin{definition}
    Let $\graph=(\nodes,\edges)$ and $\secgraph=(\node,\secedges)$ be two hypergraphs sharing their node set and $c: \edges \rightarrow \secedges$ a map.
    We say that $c$ is a coarse graining map and $\secgraph$, if for all $\edgein$
    \begin{align*}
        \edge \subset c(\edge) \, .
    \end{align*}
    For any tensor network $\graphtnetwith$ on $\graph$ we further define a coarse grained tensor network $\sectnetofat{\secgraph}{\nodevariables}$ on $\secgraph$ with hypercores to $\secedge\in\secedges$ by
    \begin{align*}
        \sechypercoreofat{\secedge}{\catvariableof{\secedge}}
        = \contractionof{\{\edgehypercorewith\wcols\secedge=c(\edge)\}}{\catvariableof{\secedge}} \, .
    \end{align*}
\end{definition}

In the literature such coarse graining procedures appear as Cluster Graphs.

We notice that coarse graining of tensor networks preserves their contractions, since
\begin{align*}
    \graphtnetwith
    &= \contractionof{\{\edgehypercorewith\wcols\edgein\}}{\nodevariables} \\
    &= \contractionof{\bigcup_{\secedge\in\secedges}\{\edgehypercorewith\wcols c(\edge)=\secedge\}}{\nodevariables} \\
    &= \contractionof{\{\contractionof{\{\edgehypercorewith\wcols c(\edge)=\secedge\}}{\edgevariables}\wcols\secedge\in\secedges\}}{\nodevariables} \\
    &= \contractionof{\{\sechypercoreofat{\secedge}{\catvariableof{\secedge}}\wcols\secedge\in\secedges\}}{\nodevariables} \\
    &= \sectnetofat{\secgraph}{\nodevariables} \, .
\end{align*}

\subsection{Coarse graining to Tree Hypergraphs}

Construction of coarse grained tree hypergraphs, by the junction tree algorithm
\begin{itemize}
    \item Amounts to triangulation of underlying "extended graph" (i.e. node pairs contained in hypergraphs)
    \item Use the cliques of the triangulated graph as hyperedges (guaranteed to be a tree, a so called "clique tree").
\end{itemize}

\subsubsection{Junction Tree Algorithm}

Classically the junction tree algorithm is formulated on the extended graph (we define extended graphs here by two nodes adjacent if and only if they are contained in a hypergraph) \cite{lauritzen_local_1988}, where one exploits that a graph has a junction tree if and only if it is triangulated \cite{lauritzen_graphical_1996}.
The junction tree algorithm therefore constructs a triangulation of the graph by adding edges (also called chordal graph \cite{koller_probabilistic_2009}), and gets a tree-hypergraph by its cliques.
Note that finding a minimal triangulation is $\mathrm{NP}$-hard.

% Formulation on hypergraphs
We can equally formulate the junction tree algorithm on hypergraphs.
Equivalent to searching for a triangulation of an extended graph, we here search for a coarse grained hypergraph, which is a tree.
Then the cliques of the triangulated graphs correspond with the hyperedges of the coarse grained hypergraph.

\red{Triangulation via Delta transform:
Choice of delta tensors and assignment to hyperedges amounts to triangulation procedure (i.e. combination of Bethe transform and coarse graining).
}

\subsubsection{Variable Elimination}

\red{Needs Delta tensor assignments at each elimination step!}

Based on disjoint subsets of $\nodes$ we can construct a coarse graining procedure of a hypergraph:
Construct iteratively $\secedges$ by iterating through the node subsets and
\begin{itemize}
    \item Add those $\edge\in\edges$ which have not been assigned before and contain variables in the subset.
    \item Choose the new edge by the union of the old one with the assigned edges in $\edges$ and dropping those nodes, which are not appearing in the rest of $\edges$ any more.
    \item Return the intersection of the new edge with the rest of $\edges$ back to $\edges$.
\end{itemize}
By construction this gives a tree hypergraph.