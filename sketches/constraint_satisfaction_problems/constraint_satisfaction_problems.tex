\documentclass[aps,onecolumn,nofootinbib,pra]{article}

\usepackage{../../spec_files/arxiv}
\input{../../spec_files/standard_preamble.tex}

\input{../../macros/organization_macros.tex}
\input{../../macros/general_macros.tex}
\input{../../macros/tc_macros.tex}
\input{../../macros/tikz_macros.tex}

\usepackage{minted}


%\newcommand{\red}[1]{\textcolor{red}{#1}}

\begin{document}
    \title{\tnreason{} for Constraint Satisfaction Problems}

    \maketitle
    \date{\today}


    We show, how Constraint Satisfaction Problems can be formalized by boolean tensor networks in the \tnreason{} notation, and how their solution can be approached by tree search, possible in combination with monte carlo approaches.


    \section{Formalization}

    \begin{definition}
        Let there be a hypergraph $\graph=(\nodes,\edges)$ and $\extnet$ be a tensor network of boolean constraint tensors $ \hypercoreofat{\edge}{\catvariableof{\edge}}$ to each $\edgein$, that is
        \[ \extnet = \{ \hypercoreofat{\edge}{\catvariableof{\edge}} \, : \, \edge\in\edges \} \, .\]
        The Constraint Satisfaction Problem CSP to $\extnet$ is the decision whether there is a state $\catindexof{\nodes}$ such that
        \[ \contractionof{\extnet}{\indexedcatvariableof{\nodes}} = 1 \, . \]
        We say the CSP is satisfiable, when there is such a state, and unsatisfiable if not.
    \end{definition}


    \section{Solution}

    \subsection{Global contraction}

    The most obvious solution is to contract the tensor network and decide the CSP based on
    \[ \contraction{\extnet} > 0 \, . \]
    This can be demanding, when having a large and densely connected tensor network.

    \subsection{Message passing}

    Local contractions instead of global provide a tradeoff between generality and efficiency.
    Their results can be passed to further contractions by message passing.
    Whenever a local contraction vanishes, the CSP is unsatisfiable.
    However, the converse is not true: In general, we cannot conclude that the CSP is satisfiable, when a message-passing scheme does converge without vanishing.

    \subsection{Guessing}

    To decide a CSP it is enough to construct a state $\catindexof{\nodes}$ which satisfies all constraint tensors.
    One procedure is to consecutively guess the state of some variables $\node\in\nodes$ and check, whether the guess can satisfy the constraint tensor.

    \subsection{Orchestration in a Backtracking Search Tree}

    We build a search tree for a constructive solution of the CSP, where each node represents a guess of a variables state.
    After a guess, a message passing scheme of varying complexity is performed to calculate the imediate consequences of the guess.
    Then an intelligent agent decides whether to
    \begin{itemize}
        \item stop the message passing scheme
        \item increase the complexity of the scheme by extending the set of communicated variables, or the size of the contraction
        \item continue with a further guess of another variable
        \item undo the previous guess (e.g. necessary when reached a vanishing message indicating inconsistency)
    \end{itemize}


    \section{Examples}

    \subsection{Temporal Clue Game}

    \begin{itemize}
        \item Nodes $\nodes$: To each characteristic of a murder (who, when, where, how etc) there is a categorical variable $\catvariableof{\node}$ with finite possibilities
        \item Edges $\edges$: To each clue and accusation, there is a constraint tensor storing the possible states consistent with the clue
    \end{itemize}

    \subsection{Graph Coloring}

    Given a graph $\graph=(\nodes,\edges)$ we design
    \begin{itemize}
        \item a variable to each nodes $\node\in\nodes$ carrying the color
        \item a constraint to each edge $\edge\in\edges$ by differing colors, i.e. $\hypercoreofat{(\node_1,\node_2)}{\catvariableof{\node_1},\catvariableof{\node_2}} = \onesofat{\catindexof{\node_1}\neq\catindexof{\node_2}}{\catvariableof{\node_1},\catvariableof{\node_2}} $
    \end{itemize}

    \subsection{Knowledge Base Satisfiability}

    As described in the main report.

    \subsection{Sudoku}

    See the computation activation drafts in the summary.
%
%    \begin{example}[Sudoku as propositional knowledge base]
%        We index the rows and the columns by tuples $(r0,r1)$ and $(co,c1)$, where $r0,r1,c0,c1\in[3]$. The first index indicates the block and the second counts the row or column inside that block.
%        For each $r0,r1,c0,c1\in[3]$ and $n\in[9]$ we then define an atomic variable $\catvariableof{r0,r1,c0,c1,n}\in\{0,1\}$ indicating whether in the row $(r0,r1)$ and column $(co,c1)$ the number $n$ is written.
%        The Sudoku rules then amount to the formula
%        \begin{align*}
%            \kb = &\left( \bigwedge_{r0,r1,c0,c1\in[3]} \left( \bigoplus_{n\in[9]} \catvariableof{r0,r1,c0,c1,n} \right) \right) \land
%            \left( \bigwedge_{r0,r1\in[3], n\in[9]} \left( \bigoplus_{c0,c1\in[3]} \catvariableof{r0,r1,c0,c1,n} \right) \right) \land \\
%            &\left( \bigwedge_{c0,c1\in[3], n\in[9]} \left( \bigoplus_{c0,c1\in[3]} \catvariableof{r0,r1,c0,c1,n} \right) \right) \land
%            \left( \bigwedge_{r0,c0\in[3], n\in[9]} \left( \bigoplus_{r1,c1\in[3]} \catvariableof{r0,r1,c0,c1,n} \right) \right) \, ,
%        \end{align*}
%        where $\bigoplus$ is the $9$-ary exclusive or connective (that is $1$ if and only if exactly one of the arguments is $1$).
%        The four outer brackets in $\kb$ mark the constraints, that at each position exactly one number is assigned, further that in each row each number is assigned once, and similar for the columns and the squares of the board.
%        When solving a specific Sudoku instance, one typically knows from an initial board assignment $E$ a collection of atomic variables, which hold, and needs to find further atomic variables, which are entailed.
%        This means, we need to decide for each $(r_0,r_1,c_0,c_1,n)\notin E$ whether the Sudoku rules and the initial board imply that the atomic variable $\catvariableof{r0,r1,c0,c1,n}$ (i.e. assignment to the board) is true
%        \begin{align*}
%            \left(\kb \land \bigwedge_{(r_0,r_1,c_0,c_1,n)\in E} \catvariableof{r0,r1,c0,c1,n} \right) \models \catvariableof{r0,r1,c0,c1,n}
%        \end{align*}
%        or false
%        \begin{align*}
%            \left(\kb \land \bigwedge_{(r_0,r_1,c_0,c_1,n)\in E} \catvariableof{r0,r1,c0,c1,n} \right) \models \lnot\catvariableof{r0,r1,c0,c1,n} \, .
%        \end{align*}
%        In other words, for each assignment to the board, that fulfills the Sudoku rules and the initial board, do we write the number $n$ in row $(r0,r1)$ and column $(c0,c1)$?
%        If and only if the Sudoku has a unique solution given the initial board assignment $E$, exactly one of these entailment statements holds for each $(r_0,r_1,c_0,c_1,n)\notin E$.
%        Deciding which is equivalent to solving of the Sudoku.
%    \end{example}
%
%    As described in the main report, Sudoku rules place categorical constraints on sets of atomic variable.
%    Each formula $\bigoplus_{\cdots}\cdots$ can be decomposed into a basis CP format, where the rank is given by the number of variables, and the decomposition variable can be interpreted as a categorical variable.

    \subsubsection{Sakana Fish Puzzle}

    \begin{figure}[t]
        \centering
        \includegraphics[width=8cm]{sakana_fish}
        \caption{Sakana Fish Puzzle}\label{fig:sakanaFish}
    \end{figure}

    In addition to the standard Sudoku rules,let us consider the constraints depicted in \figref{fig:sakanaFish}.

    \paragraph{Odd-even indicating hidden variables}
    The central hidden variable to be added is whether there is an even or odd digit at each position, denoted by $\headvariableof{r0,r1,c0,c1}$.
    We define the even checker as the function mapping even numbers to $1$ and odd to $0$, i.e.
    \begin{align*}
        E \defcols [\sudokunum^2] \rightarrow [2] \, .
    \end{align*}
    Now the even constraint is implemented
    \begin{align*}
        \bencodingofat{E}{\headvariableof{r0,r1,c0,c1},\decvariableof{r0,r1,c0,c1,:}}
        =& \tbasisat{\headvariableof{r0,r1,c0,c1}} \otimes \left(\sum_{i\in[\sudokunum^2] \wcols i \text{ is even}} \onehotmapofat{i}{\decvariableof{r0,r1,c0,c1,:}}\right) \\
        &+ \fbasisat{\headvariableof{r0,r1,c0,c1}} \otimes \left(\sum_{i\in[\sudokunum^2] \wcols i \text{ is odd}} \onehotmapofat{i}{\decvariableof{r0,r1,c0,c1,:}}\right) \, .
    \end{align*}

    \paragraph{Implementing red line constraints}
    Now along all pairs $(r0,r1,c0,c1),(\tilde{r0},\tilde{r1},\tilde{c0},\tilde{c1})$ the red lines we add constraint cores
    \begin{align*}
        \oplus\left[\headvariableof{r0,r1,c0,c1},\headvariableof{\tilde{r0},\tilde{r1},\tilde{c0},\tilde{c1}}\right]
    \end{align*}
    implementing the constraint, that odd-even digits are alternating.

    \paragraph{Implementing white dot constraints}
    These constraints can be implemented by cores to positions $(r0,r1,c0,c1),(\tilde{r0},\tilde{r1},\tilde{c0},\tilde{c1})$ connected via a white dot.
    The cores have coordinates
    \begin{align*}
        C^{\mathrm{white}}_{(r0,r1,c0,c1),(\tilde{r0},\tilde{r1},\tilde{c0},\tilde{c1})}\left[\indexeddecvariableof{r0,r1,c0,c1},\indexeddecvariableof{\tilde{r0},\tilde{r1},\tilde{c0},\tilde{c1}}\right]
        =\begin{cases}
             1 & \ifspace \absof{\decindexof{r0,r1,c0,c1}-\decindexof{\tilde{r0},\tilde{r1},\tilde{c0},\tilde{c1}}} = 1 \\
             0 & \text{else}
        \end{cases} \, .
    \end{align*}
    Note that they entail the constraints of red lines:
    \begin{align*}
        \oplus\left[\headvariableof{r0,r1,c0,c1},\headvariableof{\tilde{r0},\tilde{r1},\tilde{c0},\tilde{c1}}\right]
    \end{align*}

    \paragraph{Implementing black dot constraints}
    Analogously, the black dots can be implemented by
    \begin{align*}
        C^{\mathrm{black}}_{(r0,r1,c0,c1),(\tilde{r0},\tilde{r1},\tilde{c0},\tilde{c1})}\left[\indexeddecvariableof{r0,r1,c0,c1},\indexeddecvariableof{\tilde{r0},\tilde{r1},\tilde{c0},\tilde{c1}}\right]
        =\begin{cases}
             1 & \ifspace \decindexof{r0,r1,c0,c1}=2*\decindexof{\tilde{r0},\tilde{r1},\tilde{c0},\tilde{c1}} \\
             1 & \ifspace \decindexof{r0,r1,c0,c1}=0.5*\decindexof{\tilde{r0},\tilde{r1},\tilde{c0},\tilde{c1}} \\
             0 & \text{else}
        \end{cases} \, .
    \end{align*}
    Note that they entail the constraints (since at least one of the neighbors needs is even)
    \begin{align*}
        \lor\left[\headvariableof{r0,r1,c0,c1},\headvariableof{\tilde{r0},\tilde{r1},\tilde{c0},\tilde{c1}}\right] \, .
    \end{align*}
%

    \paragraph{Solution approach}
    Can we start the reasoning process by focusing only on the $\headvariableof{\cdot}$ variables?
    E.g. guess one, propagate on the rest and see if there is a contradiction.
%    \begin{align*}
%        \left(\headvariableof{r0,r1,c0,c1} \impbincon \headvariableof{\tilde{r0},\tilde{r1},\tilde{c0},\tilde{c1}}\right)
%        \lor
%        \left(\headvariableof{\tilde{r0},\tilde{r1},\tilde{c0},\tilde{c1}} \impbincon \headvariableof{r0,r1,c0,c1} \right)
%    \end{align*}


    \section{Toy Example for MCTS}

    As a toy example, let there be a knowledge base of atoms $A1$ and $A2$ representing two accounts to be used in an accounting proposal, and $E$ represents incoming invoices.
    The constraints are that exactly one of $A1$ or $A2$ is booked, that is $X_{A1}\oplus X_{A2}$.


    \begin{figure}[t]
        \centering
        \begin{tikzpicture}[scale=0.35, thick]

            \node[anchor=center] (text) at (-2,0) {\corelabelsize $a)$};

            \draw (-1,-5) rectangle (1, -7);
            \node[anchor=center] (text) at (0,-6) {\corelabelsize $K^{A1}$};

            \draw[] (0,-3)--(0,-5)  node[midway,left] {\colorlabelsize $X_{A1}$};
            \draw[]  (3,-3) to[bend left = -20] (4.5,-5);
            \draw (-1,-1) rectangle (4, -3);
            \node[anchor=center] (text) at (1.5,-2) {\corelabelsize ${A1} \oplus {A2}$};

            \draw (5,-1) rectangle (10, -3);
            \node[anchor=center] (text) at (7.5,-2) {\corelabelsize $E \Rightarrow A2$};
            \draw (6,-3) to[bend left = 20] (4.5,-5);
            \draw[] (4.5,-5)--(4.5,-7) node[midway,right] {\colorlabelsize $X_{A2}$};
            \draw (3.5,-9) rectangle (5.5, -7);
            \node[anchor=center] (text) at (4.5,-8) {\corelabelsize $K^{A2}$};

            \draw[] (9,-3)--(9,-5) node[midway,right] {\colorlabelsize $X_E$};

            \draw (8,-5) rectangle (10, -7);
            \node[anchor=center] (text) at (9,-6) {\corelabelsize $K^{E}$};

            \draw[fill] (4.5,-5) circle (\dotsize);

            \begin{scope}
            [shift={(25,0)}]

                \node[anchor=center] (text) at (-6,0) {\corelabelsize $b)$};

                \node[draw, circle] (A) at (0,0) {};
                \node[draw, circle] (B) at (-3,-3) {};
                \node[draw, circle] (C) at (-3,-6) {};
                \node[draw, circle] (D) at (-3,-9) {};

                \node[draw, circle] (B1) at (3,-3) {};
                \node[draw, circle] (C1) at (0,-6) {};
                \node[draw, circle] (C2) at (6,-6) {};

                \node[draw, circle] (D1) at (0,-9) {};
                \node[draw, circle] (D2) at (6,-9) {};

                % Edges
                \draw (A) -- (B) node [midway, left] {\colorlabelsize $K^{E}=e_1$};
                \draw (A) -- (B1) node [midway, right] {\colorlabelsize $K^{E}=e_0$};
                \draw (B) -- (C) node [midway, left] {\colorlabelsize $K^{A2}=e_1$};
                \draw (C) -- (D) node [midway, left] {\colorlabelsize $K^{A1}=e_1$};

                \draw (B1) -- (C1) node [midway, left] {\colorlabelsize $K^{A2}=e_1$};
                \draw (B1) -- (C2) node [midway, right] {\colorlabelsize $K^{A2}=e_0$};

                \draw (C1) -- (D1) node [midway, right] {\colorlabelsize $K^{A1}=e_0$};
                \draw (C2) -- (D2) node [midway, right] {\colorlabelsize $K^{A1}=e_1$};

            \end{scope}

        \end{tikzpicture}
        \caption{a) Tensor Network Representation of a toy CSP, in which two formulas ${A1} \oplus {A2}$ and $E\Rightarrow {A2}$ have to be satisfied.
        The Knowledge Cores $K$ contain the possible choices after a constraint propagation and are taken from $e_0,e_1,\underline{1},\underline{0}$.
        b) The corresponding search tree, where the assignments to variables are guessed in the order $E,{A2},{A1}$.
        At each parent with a single child, the other choice has been ruled out by constraint propagation.
        In our toy example with minimally connected constraints, single-core constraint propagation ensures that the guessed reasoning path remains consistent.}
    \end{figure}

\end{document}